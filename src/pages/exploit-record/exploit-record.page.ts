import { Component, ViewChild } from '@angular/core';

import {
  NavParams,
  ViewController,
  AlertController,
  Range
} from 'ionic-angular';

import Dexie from 'dexie';

import { FullSet } from '../../models/set.model';
import { FullRecord } from '../../models/record.model';
import { offset, DateService } from '../../services/date.service';
import { NumberService } from '../../services/number.service';
import { SetsService } from '../../services/sets.service';
import { RecordsService } from '../../services/records.service';
import { ItemEditModalPage } from '../item-edit-modal.page';

@Component({
  selector: 'page-exploit-record',
  templateUrl: 'exploit-record.page.html'
})
export class ExploitRecordPage
extends ItemEditModalPage<FullRecord, RecordsService> {
  readonly shiftedDate: string;
  sets: FullSet[];

  @ViewChild(Range)
  private readonly serieRange: Range;

  constructor(
    navParams: NavParams,
    viewController: ViewController,
    alertController: AlertController,
    recordsService: RecordsService,
    private readonly dateService: DateService,
    private readonly numberService: NumberService,
    private readonly setsService: SetsService
  ) {
    super(
      navParams,
      viewController,
      alertController,
      recordsService
    );

    this.shiftedDate = this.dateService.shiftISODate(this.item.date, +offset);
  }

  get set(): FullSet {
    return this.value.set;
  }

  ionViewDidEnter(): void {
    this.setsService.fetch().then(data => this.sets = data);
  }

  onSetChange(): void {
    if (!this.serieRange) { return; }
    this.serieRange.value = 1;
    this.serieRange._createTicks();
  }

  protected save(): Dexie.Promise<number> { // FIXME
    const { date, value, ...other } = this.value;
    return this.service.save({
      ...this.item,
      ...other,
      value: this.numberService.parseUnsignedInt(value as any),
      date: this.dateService.shiftISODate(date, -offset)
    });
  }
}
