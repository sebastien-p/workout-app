import { Component } from '@angular/core';
import { NavParams, ViewController } from 'ionic-angular';
import { Dexie } from 'dexie';

import { DisplayExercise } from '../../models/exercise.model';
import { DisplayWorkout } from '../../models/workout.model';
import { DisplayRecord } from '../../models/record.model';
import { ExercisesService } from '../../services/exercises.service';
import { WorkoutsService } from '../../services/workouts.service';
import { RecordsService } from '../../services/records.service';
import { ItemEditModalPage } from '../item-edit-modal.page';

const shift: number = new Date().getTimezoneOffset() * 60 * 1000 * -1; // TODO

@Component({
  selector: 'page-exploit-record',
  templateUrl: 'exploit-record.page.html'
})
export class ExploitRecordPage
extends ItemEditModalPage<DisplayRecord, RecordsService> {
  exercises: DisplayExercise[];
  workouts: DisplayWorkout[];
  date: string;

  constructor(
    navParams: NavParams,
    viewController: ViewController,
    recordsService: RecordsService,
    private readonly exercisesService: ExercisesService,
    private readonly workoutsService: WorkoutsService
  ) {
    super(
      navParams,
      viewController,
      recordsService
    );

    this.date = this.getShiftedISODate(this.item.date, +shift);
  }

  ionViewDidEnter(): void {
    this.exercisesService.fetch().then(data => this.exercises = data);
    this.workoutsService.fetch().then(data => this.workouts = data);
  }

  protected save(): Dexie.Promise<number> { // TODO
    const { date, ...value } = this.value;
    return this.service.save({
      ...this.item,
      ...value,
      date: this.getShiftedISODate(date, -shift),
    });
  }

  private getShiftedISODate(date: string, offset: number): string {
    return new Date(new Date(date).getTime() + offset).toISOString();
  }
}
