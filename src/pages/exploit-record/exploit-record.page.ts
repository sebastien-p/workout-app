import { Component } from '@angular/core';
import { NavParams, ViewController } from 'ionic-angular';
import { Dexie } from 'dexie';

import { DisplayExercise } from '../../models/exercise.model';
import { DisplayWorkout } from '../../models/workout.model';
import { DisplayRecord } from '../../models/record.model';
import { offset, DateService } from '../../services/date.service';
import { NumberService } from '../../services/number.service';
import { ExercisesService } from '../../services/exercises.service';
import { WorkoutsService } from '../../services/workouts.service';
import { RecordsService } from '../../services/records.service';
import { ItemEditModalPage } from '../item-edit-modal.page';

@Component({
  selector: 'page-exploit-record',
  templateUrl: 'exploit-record.page.html'
})
export class ExploitRecordPage
extends ItemEditModalPage<DisplayRecord, RecordsService> {
  readonly shiftedDate: string;
  exercises: DisplayExercise[];
  workouts: DisplayWorkout[];

  constructor(
    navParams: NavParams,
    viewController: ViewController,
    recordsService: RecordsService,
    private readonly dateService: DateService,
    private readonly numberService: NumberService,
    private readonly exercisesService: ExercisesService,
    private readonly workoutsService: WorkoutsService
  ) {
    super(
      navParams,
      viewController,
      recordsService
    );

    this.shiftedDate = this.dateService.shiftISODate(this.item.date, +offset);
  }

  ionViewDidEnter(): void {
    this.exercisesService.fetch().then(data => this.exercises = data);
    this.workoutsService.fetch().then(data => this.workouts = data);
  }

  protected save(): Dexie.Promise<number> { // FIXME
    const { date, serie, value, ...other } = this.value;
    return this.service.save({
      ...this.item,
      ...other,
      serie: this.numberService.parseUnsignedInt(serie as any, 1),
      value: this.numberService.parseUnsignedInt(value as any),
      date: this.dateService.shiftISODate(date, -offset)
    });
  }
}
