import { Component, ViewChild } from '@angular/core';
import { Content, NavParams, ViewController } from 'ionic-angular';

import { Pauseable } from '../../models/pauseable.model';
import { DisplayWorkout } from '../../models/workout.model';
import { DisplaySet } from '../../models/set.model';
import { WorkoutsService } from '../../services/workouts.service';

import {
  CountdownComponent
} from '../../components/countdown/countdown.component';

import { ItemModalPage } from '../item-modal.page';

type Shifter = (set: DisplaySet) => DisplaySet;

type Initializer = (
  previous: DisplaySet,
  current: DisplaySet,
  next: DisplaySet,
  shifter: Shifter
) => void;

@Component({
  selector: 'page-exploit-workout',
  templateUrl: 'exploit-workout.page.html'
})
export class ExploitWorkoutPage
extends ItemModalPage<DisplayWorkout, WorkoutsService> {
  previous: DisplaySet;
  current: DisplaySet;
  next: DisplaySet;
  serieNumber: number;

  @ViewChild(Content)
  private readonly content: Content;

  @ViewChild(CountdownComponent)
  private readonly countdown: CountdownComponent;

  constructor(
    navParams: NavParams,
    viewController: ViewController,
    workoutsService: WorkoutsService
  ) {
    super(
      navParams,
      viewController,
      workoutsService
    );
    this.initialize(1, null, ...this.sets.slice(0, 2));
  }

  get hasSet(): boolean {
    return !!this.current;
  }

  get isFirstSet(): boolean {
    return !this.previous;
  }

  get isLastSet(): boolean {
    return !this.next;
  }

  get isFirstSerie(): boolean {
    return !this.hasSet || this.serieNumber === 1;
  }

  get isLastSerie(): boolean {
    return !this.hasSet || this.serieNumber === this.current.series;
  }

  get isStart(): boolean {
    return this.isFirstSet && this.isFirstSerie;
  }

  get isEnd(): boolean {
    return this.isLastSet && this.isLastSerie;
  }

  get canSave(): boolean { // TODO: when has something to save
    // return this.hasSet && this.isEnd;
    return false;
  }

  get setNumber(): number {
    return this.getIndex() + 1;
  }

  get pauseable(): Pauseable {
    return this.isLastSerie ? this.item : this.current;
  }

  showPrevious(): void {
    this.show(-1, (previous, current, next, shifter) => this.initialize(
      previous.series,
      shifter(previous),
      previous,
      current
    ), this.isStart, this.isFirstSerie);
  }

  showNext(): void {
    this.show(+1, (previous, current, next, shifter) => this.initialize(
      1,
      current,
      next,
      shifter(next)
    ), this.isEnd, this.isLastSerie);
  }

  private get sets(): DisplaySet[] {
    return this.item.sets;
  }

  private getIndex(set: DisplaySet = this.current): number {
    return this.sets.indexOf(set);
  }

  private initialize(
    serieNumber: number,
    previous: DisplaySet = null,
    current: DisplaySet = null,
    next: DisplaySet = null
  ): void {
    this.previous = previous;
    this.current = current;
    this.next = next;
    this.serieNumber = serieNumber;
    if (this.content) { this.content.resize(); }
  }

  private show(
    shift: number,
    initializer: Initializer,
    shouldNotDoAnything: boolean,
    shouldInitializeSet: boolean
  ): void {
    if (shouldNotDoAnything) { return; }
    if (shouldInitializeSet) {
      const shifter: Shifter = set => this.sets[this.getIndex(set) + shift];
      initializer(this.previous, this.current, this.next, shifter);
    }
    else {
      this.serieNumber += shift;
      if (this.countdown) { this.countdown.stop(); }
    }
  }
}
