import { Component, ViewChild } from '@angular/core';

import {
  NavParams,
  ViewController,
  AlertController,
  Content
} from 'ionic-angular';

import { FullExercise } from '../../models/exercise.model';
import { FullWorkout } from '../../models/workout.model';
import { FullSet } from '../../models/set.model';
import { Stats } from '../../models/stats.model';
import { DateService } from '../../services/date.service';
import { NumberService } from '../../services/number.service';
import { WorkoutsService } from '../../services/workouts.service';
import { RecordsService } from '../../services/records.service';

import {
  CountdownComponent
} from '../../components/countdown/countdown.component';

import { ItemModalPage } from '../item-modal.page';

type Shifter = (set: FullSet) => FullSet;

type Initializer = (
  previous: FullSet,
  current: FullSet,
  next: FullSet,
  shifter: Shifter
) => void;

@Component({
  selector: 'page-exploit-workout',
  templateUrl: 'exploit-workout.page.html'
})
export class ExploitWorkoutPage
extends ItemModalPage<FullWorkout, WorkoutsService> {
  previous: FullSet;
  current: FullSet;
  next: FullSet;
  serieNumber: number;
  thisTime: Stats;
  lastTime: Stats;
  private readonly date: string;

  @ViewChild(Content)
  private readonly content: Content;

  @ViewChild(CountdownComponent)
  private readonly countdown: CountdownComponent;

  constructor(
    navParams: NavParams,
    viewController: ViewController,
    alertController: AlertController,
    dateService: DateService,
    workoutsService: WorkoutsService,
    private readonly numberService: NumberService,
    private readonly recordsService: RecordsService
  ) {
    super(
      navParams,
      viewController,
      alertController,
      workoutsService
    );

    this.date = dateService.getISODate();
    this.initialize(1, null, ...this.sets.slice(0, 2));
  }

  get hasSet(): boolean {
    return !!this.current;
  }

  get isFirstSet(): boolean {
    return !this.previous;
  }

  get isLastSet(): boolean {
    return !this.next;
  }

  get isFirstSerie(): boolean {
    return !this.hasSet || this.serieNumber === 1;
  }

  get isLastSerie(): boolean {
    return !this.hasSet || this.serieNumber === this.current.series;
  }

  get isStart(): boolean {
    return this.isFirstSet && this.isFirstSerie;
  }

  get isEnd(): boolean {
    return this.isLastSet && this.isLastSerie;
  }

  get shouldRecord(): boolean {
    return this.item.record && this.hasSet;
  }

  get setNumber(): number {
    return this.getIndex() + 1;
  }

  get exercise(): FullExercise {
    return this.hasSet ? this.current.exercise : null;
  }

  get rest(): FullWorkout | FullSet {
    return this.isLastSerie ? this.item : this.current;
  }

  ionViewCanLeave(): boolean | Promise<boolean> {
    return !this.hasSet || this.confirm();
  }

  showPrevious(): void {
    this.show(-1, (previous, current, next, shifter) => this.initialize(
      previous.series,
      shifter(previous),
      previous,
      current
    ), this.isStart, this.isFirstSerie);
  }

  showNext(): void {
    this.show(+1, (previous, current, next, shifter) => this.initialize(
      1,
      current,
      next,
      shifter(next)
    ), this.isEnd, this.isLastSerie);
  }

  promptValue(): void {
    if (!this.shouldRecord) { return; }
    const { current, serieNumber } = this;
    this.prompt('How many repetitions?', 'number', '0').then(value => {
      if (!value) { return; }
      this.recordValue(
        this.numberService.parseUnsignedInt(value), // FIXME
        serieNumber,
        current
      );
    });
  }

  private get sets(): FullSet[] {
    return this.item.sets;
  }

  private getIndex(set: FullSet = this.current): number {
    return this.sets.indexOf(set);
  }

  private initializeStats(): void {
    if (!this.shouldRecord) { return; }
    this.thisTime = this.recordsService.createStats(this.current.series);
    this.recordsService.fetch(this.current).then(data => this.lastTime = data);
  }

  private initialize(
    serieNumber: number,
    previous: FullSet = null,
    current: FullSet = null,
    next: FullSet = null
  ): void {
    this.previous = previous;
    this.current = current;
    this.next = next;
    this.serieNumber = serieNumber;
    this.initializeStats();
    if (this.content) { this.content.resize(); }
  }

  private show(
    shift: number,
    initializer: Initializer,
    shouldDismissModal: boolean,
    shouldInitializeSet: boolean
  ): void {
    if (shouldDismissModal) {
      this.dismiss();
    }
    else if (shouldInitializeSet) {
      const shifter: Shifter = set => this.sets[this.getIndex(set) + shift];
      initializer(this.previous, this.current, this.next, shifter);
    }
    else {
      this.serieNumber += shift;
      if (this.countdown) { this.countdown.stop(); }
    }
  }

  private recordValue(value: number, serie: number, set: FullSet): void {
    this.thisTime.values[serie - 1] = value;
    this.thisTime.total += value;
    this.recordsService
      .save(this.recordsService.create(set, serie, value, this.date));
  }
}
